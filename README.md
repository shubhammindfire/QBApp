# QBApp

This app integrates with the QuickBooks Online API and enables invoice creation and management. You can also view list of customers and items.

## Technologies used

-   FrontEnd
    -   ReactJS
    -   Redux
    -   Tailwind CSS
    -   React Router
    -   Axios
-   Backend
    -   Symfony5
    -   MySQL

## Installation and development guide

If you wish to run this app locally please follow the below steps:

-   Please make sure you have these installed on your machine:
    -   Node v15.12.0
    -   NPM v7.6.3
    -   PHP v7.4.3
    -   Composer v2.0.12
    -   MySQL v8.0.25
-   Clone this repo
-   Move to `frontend/react_qb` and run `npm install`
-   Move to `backend/symfony_api/api` and run `composer install`
-   Add a `config.php` at `backend` as shown below:

```
<?php
return array(
    'authorizationRequestUrl' => 'https://appcenter.intuit.com/connect/oauth2',
    'tokenEndPointUrl' => 'https://oauth.platform.intuit.com/oauth2/v1/tokens/bearer',
    'client_id' => 'YOUR_CLIENT_ID',
    'client_secret' => 'YOUR_CLIENT_SECRET',
    'oauth_scope' => 'com.intuit.quickbooks.accounting openid profile email phone address',
    'oauth_redirect_uri' => 'YOUR_CALLBACK_URI_AS_SETUP_IN_QUICKBOOKS_ONLINE_APP_CONFIG',
    'username' => 'YOUR_MYSQL_USERNAME',
    'password' => 'YOUR_MYSQL_PASSWORD',
    'dbname' => 'YOUR_MYSQL_DATABASE_NAME',
    'customer_tablename' => 'YOUR_CUSOTMERS_TABLE_NAME',
    'item_tablename' => 'YOUR_ITEMS_TABLE_NAME',
    'invoiceItem_tablename' => 'YOUR_INVOICES_ITEMS_TABLE_NAME',
    'invoice_tablename' => 'YOUR_INVOICES_TABLE_NAME',
    'user_tablename' => 'YOUR_USERS_TABLE_NAME'
);

```

-   Generate public and private key files for lexik_jwt package and place them at `backend/symfony_api/api/config/jwt/`
-   Add a `.env` at `backend/symfony_api/api/` as,

```
###> symfony/framework-bundle ###
APP_ENV=prod
APP_SECRET=APP_SECRET_GENERATED_BY_SYMFONY
###< symfony/framework-bundle ###

###> doctrine/doctrine-bundle ###
# Format described at https://www.doctrine-project.org/projects/doctrine-dbal/en/latest/reference/configuration.html#connecting-using-a-url
# IMPORTANT: You MUST configure your server version, either here or in config/packages/doctrine.yaml
#
DATABASE_URL="mysql://YOUR_USERNAME:YOUR_PASSWORD@127.0.0.1:3306/YOUR_DATABASE_NAME?serverVersion=5.7"
###< doctrine/doctrine-bundle ###

###> nelmio/cors-bundle ###
#CORS_ALLOW_ORIGIN='^https?://(localhost|127\.0\.0\.1)(:[0-9]+)?$'
CORS_ALLOW_ORIGIN=^https?://.*?$
###< nelmio/cors-bundle ###

###> lexik/jwt-authentication-bundle ###
JWT_SECRET_KEY=%kernel.project_dir%/config/jwt/private.pem
JWT_PUBLIC_KEY=%kernel.project_dir%/config/jwt/public.pem
JWT_PASSPHRASE=JWT_PASSPHRASE_GENERATED_BY_JWT
###< lexik/jwt-authentication-bundle ###
```

-   For running the react app run `npm run start` in `frontend/react_qb`
-   For running the symfony app, you can run a local php server with `php -S localhost:8000` or use the symfony cli command `symfony serve` (please note that to for this you must install the symfony cli on your machine)

## Production deplotment guide

This guide assumes that you have root access to the production server and have apache and mysql installed installed on it.

-   Place the contents of the `build/` folder in the `/var/www/html/` (The `build/` folder can be generated by running `npm run build` on your machine. Then you can manually copy the contents of this folder to your production server or have a CI/CD pipeline to do this automatically for you.)
-   Make sure that the default virtual host in the `/etc/apache2/sites-available/000-default.conf` is as below

```
<VirtualHost *:80>
        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

-   Also you need to add the below conf to your `/etc/apache2/apache2.conf`

```
<Directory "/var/www/html/">
        AllowOverride All
</Directory>
```

These 2 configs shown above enables you to run the react app on your domain name like `www.qbapp.com`

-   You need to add a `.htaccess` file with the contents shown below, in the `/var/www/html/`(you need to place it in the same directory where you place your `index.html` of the `build/` directory generated above)

```
Options -Multiviews
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^ index.html [QSA,L]
```

This `.htaccess` is very useful if your are using React Router(the `react-router-dom` package) in your react app. This tells apache to send the routes handing to the `index.html` file.(please check the last line of `.htaccess` file code above)

-   Add a `homepage` attribute to your `package.json` file as shown below(it assumes that your domain name is `http://www.qbapp.com`)

```
"homepage": "http://www.qbapp.com"
```

-   You also need to change the `BASE_SERVER_URL` in the `frontend/react_qb/src/Constants.js` as given below:

```
export const BASE_SERVER_URL = "http://backend.qbapp.com";
```

This is for the virtual host conf that we are going to setup in the coming steps.
Now, this completes the changes that you need to do for the react app.

-   For the symfony app, copy the complete backend code to the production server. Here we assume that the code is at `/var/www/html/QBApp/backend/`
-   Now add a virtual host at `/etc/apache2/sites-available/qbapp.backend.conf` with the contents shown below:

```
<VirtualHost *:80>
        ServerAdmin admin@example.com
        ServerName backend.qbapp.com
        DocumentRoot /var/www/html/QBApp/backend/symfony_api/api/public
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
        <Directory /var/www/html/QBApp/backend/symfony_api/api/public>

                Options Indexes FollowSymLinks MultiViews

                AllowOverride All

                Order allow,deny

                allow from all

        </Directory>
        SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
</VirtualHost>
```

the `SetEnvIf Authorization ...` line allows the authorization bearer header to work on apache, otherwise it is filtered out by default.

-   You also need to add `export SYMFONY_ENV=prod` at the end of your `.profile` file in the home directory(assuming you have Ubuntu Linux on your server). This will set the production env as prod for symfony.
-   In the `backend/symfony_api/api/src/Controller/QuickBooksController.php` at the end of the `processCode()` function change <br>`return $this->redirect("http://localhost:3000/portal");` <br>to <br>`return $this->redirect("http://www.qbapp.com/portal");`<br> assuming `www.qbapp.com` is the url for the react server.
    This finishes the setup for backend.
-   Now for all of this to work you need to add the urls `www.qbapp.com` and `backend.qbapp.com` to your `/etc/hosts` on your local machine as,

```
PUBLIC_IP_OF YOUR_SERVER   www.qbapp.com
PUBLIC_IP_OF_YOUR_SERVER   backend.qbapp.com
```

The above step is crucial because the urls shown above have not be bought and thus do not apply globally.

### Git commit practises

-   Init - Initial setup of a project
-   Feature - a new feature
-   Bug Fix - a bug fix
-   Docs - changes in documentation
-   Style - everything related to styling
-   Refactor - code changes that neither fixes a bug or adds a feature
-   Testing - code changes related to testing
